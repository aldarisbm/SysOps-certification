# Scalability and High Availability

- Scalability - means that your app / system can handle greater loads by adapting
    - Two kinds of Scalability
        - Vertical
        - Horizontal (elasticity)
    - Scalability is linked but different to HA

### Vertical Scalability
- Vertically scalability means increasing the size of the instance

### Horizontal Scalability
- Means increasing number of instances / systems for your application

### High Availability
- Usually goes in hand with horizontal scaling
- HA means running application/system in at least 2 data centers (AZs)
- The goal of HA is to survive a data center loss
- High Availability can be passive (for RDS multi AZ for example)
- High Availability can be active (horizontal scaling)

### What is load balancing?

- LB are servers that forward internet traffic to multiple services (ec2 instances) downstream (upstream?)

### Why use a load balancer?
- Spread load across multiple downstream instances
- Expose a single point of access (DNS) to your app
- Seamlessly handle failure of your apps
- Do regular health checks to your instances
- Provide SSL termination (HTTPS) for your websites
- Enforce stickiness
- HA across zones
- Separate public traffic from private traffic

- ELB (managed lb)
    - Will work
    - Upgraded
    - Provided only a few config knobs
- It cost less to setup your own lb but it will be a lot of more effort
- It is integrated with AWS

### 3 Kind of LBs
- Classic Load Balancer
- Application Load Balancer
- Network Load Balancer

- You can setup internal or external LB

### Health Checks
- Crucial for Load Balancers
- Enable the LB to know if instances it forwards traffic to are avai to reply to requests
- The health check is done on a port and a route `/health`
- If response no 200(ok) then instance is unhealthy

### ALB
- Layer 7
    - Multiple HTTP apps across machines (Target Groups)
    - Load balancing to multiple applications on the same machine
    - Load balancing based on Route in URL
    - Load balancing based on Hostname in URL
- Great fit for microservices & containerbased apps
- Port Mapping feature to redirect to a dynamic port

 - Stickiness at the TG level
    - Same request goes to the same instances
    - Stickiness is directly generated by the ALB
- ALB supports
    - HTTP
    - HTTPS
    - Websockets
- Application servers don't see the IP of the client
    - Header: x-Forward-For (real ip client)
    - Can also get port and proto (X-Forwarded-Port | X-Forwarded-Proto)

### NLB
- Layer 4
    - TCP traffic to your instances
    - Handle millions of requests per seconds
    - Support for static IP or elastic IP
    - Less latency (100 vs 400ms alb)

- Extreme performance - Should not be the default you choose


### GTK
- CLB is deprecated
- ALB for HTTP/HTTPS & Websocket
- NLB for TCP

- CLB and ALB support SSL certs and provide SSL termination
- All load balancers have health check capability
- ALB can route based on host/path
- ALB great fit for ECS/Docker

- All LB has a static host name (DO NOT RESOLVE and use UNDERLYING IP)
- LBs can scale but no instantly - contact AWS for a "warm-up" 
- NLB directly see the client IP (not x forw...)
- 4xx errors are client induced errors
- 5xx errors are app induced errors
    - LB 503 (no capacity or no registered target)
- If the LB cant connect to your application, check your security groups

### Load Balancer Stickiness
- It is possible to implement stickiness so that the same client is always redirected to the same instance behind a load balancer
- this work for CLB and ALB
- The "cookie" used for stickiness has an xp date
- Make sure the user doesnt lose his session data
- Enabling stickiness may bring imbalance to the load over the backend EC2 instances

### LB for SysOps
- ALB layer 7 (HTTP/S, Websockets)
- URL based routing (hostname or path)
- Does not support static IP, but has fixed DNS
- Provide SSL termination

- NLB layer 4 (TCP)
- No pre-warming needed
- 1 static IP per subnet
- No SSL (ssl must be enabled by the application itself)

- Exam Tip (Chain NLB and ALB to give a ALB a fixed IP!!)

- Load Balancer Pre-warming
    - ELB scale gradually to traffic
    - ELB may fail in case of suddent spike of traffic (10x traffic)
    - If you expect high traffic (xmas seasons) open a support ticket with AWS to pre-warm your ELB
        - Duration of traffic
        - Expected requests per second
        - Size of request (in KB)
- Load balancer Error codes
    - Successful request (200)
    - Unsucessful at clientside (4xx)
        - 400 bad request
        - 401 unathorized
        - 403 forbidden
        - 460 client closed connection
        - 463 X-Forward for header has over 30 ips
    - Unsuccessful at server side: (5xx)
        - 500 / Internal server erorr
        - 502 Bad Gateway
        - 503 Service Unavailable
        - 504 Gateway Timeout
        - 561 Unauthorized
- Support SSL for Old Browsers
    - How do we support legacy browsers that have an old TLS (tls 1.0)
    - Change the policy to allow for weaker cipher (eg DES-CBC3-SHA for TLS 1.0)
    - Only a very small % of the internet uses TLS 1.0

    - ELB provides the following security policies for ALBs:
        - Many but last one is for TLS 1.0 (boo weaker cipher)

- Common troubleshooting
    - Check SGs
    - Check Health Checks
    - Look at sticky sessions (imbalance)
    - For Multi-AZ make sure cross-zone balancing is enabled
    - Internal load balancer for private applications (dont need public access)
    - Enable Deletion Protection!!!

### Load Balancers Monitoring
- All LB metrics are directly pushed to CloudWatch metrics
- Backend connection errors
- HealthyHostcount / Unhealthy
- HTTPCode_Backend_2xx: Succ
- HTTPCode_Backend_3xx: Red
- HTTPCode_Backend_4xx: Client error
- HTTPCode_Backend_5xx: Server error

- Latency
- RequestCount
- SurgeQueueLength - Total number of requests (http listener) or connections(TCP) that are pending routing to a health instance. Max value: 1024
    - When its filled
        - SpilloverCount: total number of rejected requests because surge queue is full!!

### AutoScaling Groups

- In real life the load on your websites/apps will change
- In the cloud, you can craete and get rid of servers very quickly

- The goal of AGS is
    - Scale out - to match increased load
    - Scale in - to match decreased load
    - Ensure we have a min and max of machines running
    - automatically register new instances to the lb

- ASG have the following attributes
    - A launch config
        - AMI + instance type
        - EC2 user data
        - EBS Volumes
        - SGs
        - SSH keypair
    - Min Size / Max Size / Initial Capacity
    - Network + subnets info
    - Load Balancer Info
    - Scaling Policies

- Auto Scaling Alarms
    - It is possible to scale an ASG based on CloudWatch alarms
    - An Alarm monitors a metric (such as average CPU)
    - Metrics are computed for the overall ASG instances
    - Based on the alarm
        - scale in
        - scale out

- Auto Scaling New Rules
    - It is now possible to define better as rules that are directly managed by ec2
        - target average cpu usage
        - number of requets on the elb per instance
        - average ntwork in
        - average ntwork out
    - These rules are easier to setup and can make more sense

- Auto Scaling Custom Metric

- We can auto scale based on a custom metric (ex: number of connected users)

- 1 Send custom metric from app on ec2 to cloudwatch
- 2 Create cw alarm to react to low/high values
- 3 user the cw alarm as the scaling policy for ASG

#### Scaling Processes
- Launch Add a new ec2 to the group (incr)
- Terminate Removes an ec2 (decr)
- HealthCheck Checks healths of instances
- ReplaceUnhealthy terminate unhealthy and recreate
- AZRebalance Balancer the number of EC2 instances across AZ
- AlarmNotification Accept Notification from CloudWatch
- ScheduledActions Performs Scheduled actions that you create
- AddToLoadBalancer Adds instances to the LB or TG

- Note on AZ rebalc
    - If you suspend Launch process
        - AZRebalance wont launch instances
        - AZRebalance wont terminate instances
    - If you suspend the Terminate process
        - ASG can grow up to 10% of this size (its allowed during rebalances)
        - ASG could remain at the increased capacity as it cant terminate instances

#### ASG for SysOps
- HA You need an ASG configured to have at least 2 instances running across 2 AZs
- Health Checks available
    - EC2 Status Checks (if VM is ok or underlying hw, but wont tell you info about app)
    - ELB Health Checks (will tell you our app is good)
- ASG will launch a new instance after terminating an unhealthy one
- ASG will not reboot unhealthy hosts for you
- Good to know CLI
    - `set-instance-health`
    - `terminate-instance-in-auto-scaling-group`

#### TroubleShooting ASG issues
- \# of instances are already running. Launching EC2 instance failed
    - ASG has reached the limit set by the DesiredCapacity parameter. Update your ASG by providing a new value for desired capacity
- Launching EC2 instances is failing:
    - SG doesnt exist (deleted?)
    - Key Pair doesnt exist (deleted?)

- If the ASG fails to launch an instance for over 24 hours, it will automatically suspend the processes (administration suspension)

#### CloudWatch Metrics for ASG
- Following Metrics are avail for ASG:
    - GroupMinSize
    - GroupMaxSize
    - GroupDesiredCapacity
    - GroupInServiceInstances
    - GroupPendingInstances
    - GroupstandbyInstances
    - GroupTerminatingInstances
    - GroupTotalInstances

- You should enable protection collection
- Metrics collected every minute

- MOnitor underlying EC2
    - Default 5 mins
    - Detailed at 1 min